<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>DevSocket HTTP → WebSocket Demo</title>
    <style>
      body { max-width: 600px ;font-family: system-ui, sans-serif; margin: 2em auto; }
      input, button { padding: 6px 10px; margin: 0.2em; }
      button { font-weight: bold; }
      #log { border: 1px solid #ccc; padding: 8px; height: 200px; overflow: auto; white-space: pre-wrap; }
    </style>
  </head>
  <body>
    <h1>DevSocket HTTP → WebSocket Demo</h1>

    <table>
      <tr>
        <td>Channel:</td>
        <td><input id="channel" value="test" /></td>
        <td><button id="connect">Connect</button></td>
        <td><span id="status">disconnected</span></td>
      </tr>
      <tr>
        <td>Message:</td>
        <td><input id="plainText" value="hello world" /></td>
        <td colspan="2"><button id="sendPlain">Send plain</button></td>
      </tr>
      <tr>
        <td>Message:</td>
        <td><input id="jsonText" value='{"msg":"hi","n":1}' /></td>
        <td colspan="2"><button id="sendJson">Send JSON</button></td>
      </tr>
    </table>

    <h3>Messages</h3>
    <div id="log"></div>

    <script>
      let ws = null;
      const $ = id => document.getElementById(id);
      const log = (msg) => {
        $("log").textContent += msg + "\n";
        $("log").scrollTop = $("log").scrollHeight;
      };

      $("connect").onclick = () => {
        const ch = $("channel").value;
        if (ws) ws.close();
        ws = new WebSocket(`ws://${location.host}/ws/${ch}`);
        ws.onopen = () => $("status").textContent = "connected";
        ws.onclose = () => $("status").textContent = "disconnected";
        ws.onmessage = (e) => log("← " + e.data);
      };

      $("sendPlain").onclick = async () => {
        const ch = $("channel").value;
        const txt = $("plainText").value;
        await fetch(`/publish/${ch}`, {method:"POST", body: txt});
        log("→ plain: " + txt);
      };

      $("sendJson").onclick = async () => {
        const ch = $("channel").value;
        const js = $("jsonText").value;
        await fetch(`/publish/${ch}`, {
          method:"POST",
          headers: {"Content-Type":"application/json"},
          body: js
        });
        log("→ json: " + js);
      };
    </script>
  </body>
</html>
